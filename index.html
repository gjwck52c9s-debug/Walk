<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0B1B2B" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>WalkCut</title>

  <!-- Embedded iOS icon (simple armored silhouette) -->
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180' viewBox='0 0 180 180'%3E%3Cdefs%3E%3CradialGradient id='g' cx='30%25' cy='20%25' r='80%25'%3E%3Cstop offset='0' stop-color='%233aa0ff' stop-opacity='.25'/%3E%3Cstop offset='1' stop-color='%230B1B2B'/%3E%3C/radialGradient%3E%3C/defs%3E%3Crect width='180' height='180' rx='36' fill='url(%23g)'/%3E%3Crect x='10' y='10' width='160' height='160' rx='30' fill='%230b1118' opacity='.55'/%3E%3Cpath d='M40 104h86l8 12H32l8-12Zm8-20h70l6 12H42l6-12Zm10-16h44l8 8H50l8-8Zm38-6 18 10H80l16-10Zm-57 56h94v10H39v-10Zm8 16h10v8H47v-8Zm18 0h10v8H65v-8Zm18 0h10v8H83v-8Zm18 0h10v8h-10v-8Zm18 0h10v8h-10v-8Z' fill='%23C9A24D'/%3E%3Ctext x='90' y='52' text-anchor='middle' font-family='-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial' font-size='18' fill='%23EAF0F6'%3EWALKCUT%3C/text%3E%3C/svg%3E" />

  <style>
    :root{
      --navy:#0B1B2B; --bg:#0b1118; --text:#e8eef6; --muted:#8FA3B8;
      --accent:#C9A24D; --blue:#3aa0ff; --green:#3ddc97; --red:#ff6b6b;
      --border: rgba(201,162,77,.18);
      --r:16px; --pad:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text",system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:var(--sans);color:var(--text);
      background:
        radial-gradient(1200px 900px at 20% -10%, rgba(58,160,255,.14), transparent 60%),
        radial-gradient(1000px 800px at 110% 10%, rgba(201,162,77,.12), transparent 55%),
        radial-gradient(900px 700px at 50% 120%, rgba(61,220,151,.08), transparent 55%),
        var(--bg);
    }
    header{position:sticky;top:0;z-index:10;padding:12px 14px 10px;
      backdrop-filter: blur(14px); background: rgba(11,27,43,.78);
      border-bottom:1px solid rgba(201,162,77,.18);
    }
    .top{display:flex;align-items:center;justify-content:space-between;gap:10px;}
    h1{margin:0;font-size:18px;display:flex;align-items:center;gap:10px;letter-spacing:.35px;}
    .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(180deg,rgba(201,162,77,1),rgba(58,160,255,.9));box-shadow:0 0 0 3px rgba(201,162,77,.16);}
    .pill{font-size:12px;color:rgba(201,162,77,.95);border:1px solid rgba(201,162,77,.22);background:rgba(201,162,77,.06);padding:5px 10px;border-radius:999px;white-space:nowrap;}
    main{padding:12px 14px 94px;max-width:980px;margin:0 auto;}
    .grid{display:grid;gap:12px;}
    @media(min-width:760px){.grid.two{grid-template-columns:1fr 1fr}.grid.three{grid-template-columns:1fr 1fr 1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(0,0,0,.10));border:1px solid var(--border);
      border-radius:var(--r);padding:var(--pad);box-shadow:0 14px 34px rgba(0,0,0,.45);}
    .card h2{margin:0 0 10px;font-size:13px;color:rgba(201,162,77,.95);font-weight:900;letter-spacing:.35px;}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family:var(--mono)}
    .divider{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .kpi{display:flex;gap:10px;flex-wrap:wrap}
    .box{flex:1 1 120px;min-width:120px;border-radius:12px;background:rgba(0,0,0,.20);border:1px solid rgba(201,162,77,.16);padding:10px 12px;}
    .label{font-size:12px;color:var(--muted);margin-bottom:4px}
    .value{font-size:18px;font-weight:950;font-family:var(--mono)}
    button{appearance:none;border:none;border-radius:12px;padding:10px 12px;font-weight:900;letter-spacing:.2px;cursor:pointer;
      background:linear-gradient(180deg,rgba(201,162,77,.22),rgba(201,162,77,.12));
      color:var(--text);border:1px solid rgba(201,162,77,.30);
      -webkit-tap-highlight-color:transparent;touch-action:manipulation;user-select:none;
    }
    button.secondary{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10)}
    button.danger{background:rgba(255,107,107,.12);border:1px solid rgba(255,107,107,.32)}
    button:active{transform:translateY(1px)}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.18);color:var(--text);font-size:14px;outline:none}
    textarea{min-height:76px;resize:vertical}
    label{display:block;margin:10px 0 6px;font-size:12px;color:var(--muted)}
    .tabs{position:fixed;left:0;right:0;bottom:0;z-index:10;display:flex;gap:8px;justify-content:space-around;
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
      background:rgba(11,27,43,.88);backdrop-filter:blur(14px);border-top:1px solid rgba(201,162,77,.16);
    }
    .tab{flex:1;text-align:center;font-size:12px;font-weight:950;padding:9px 6px;border-radius:12px;color:rgba(232,238,246,.78);
      background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);
    }
    .tab.active{color:var(--text);background:rgba(201,162,77,.14);border:1px solid rgba(201,162,77,.22)}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap}
    .progress{height:10px;border-radius:999px;background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.08);overflow:hidden}
    .progress>div{height:100%;width:0%;background:linear-gradient(90deg,rgba(61,220,151,.92),rgba(201,162,77,.85))}
    .mwrap{display:grid;gap:10px;margin-top:10px}
    .mrow{display:grid;grid-template-columns: 56px 1fr 64px;gap:10px;align-items:center}
    .mname{font-size:12px;color:var(--muted);font-weight:950}
    .mpct{font-size:12px;color:var(--muted);text-align:right;font-family:var(--mono)}
    .mbar{height:12px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);overflow:hidden}
    .mbar>div{height:100%;width:0%;background:rgba(58,160,255,.9)}
    canvas{width:100%;height:220px;background:rgba(0,0,0,.16);border:1px solid rgba(201,162,77,.16);border-radius:12px}
    #toast{position:fixed;left:14px;right:14px;bottom:calc(78px + env(safe-area-inset-bottom));z-index:9999;display:none;
      padding:12px 14px;border-radius:14px;background:rgba(11,27,43,.92);border:1px solid rgba(201,162,77,.22);
      box-shadow:0 18px 40px rgba(0,0,0,.45);font-weight:950
    }
    #toast .sub{display:block;margin-top:4px;font-weight:700;color:var(--muted);font-size:12px}
    .mini{background:rgba(0,0,0,.14);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:10px 12px}
    table{width:100%;border-collapse:collapse}
    td,th{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px}
    th{color:var(--muted);text-align:left;font-weight:900}
    .right{text-align:right}
  
    details.dropdown{border:1px solid rgba(255,255,255,.10);border-radius:12px;background:rgba(0,0,0,.14);overflow:hidden}
    summary.dropdownSummary{list-style:none;cursor:pointer;padding:10px 12px;font-weight:950;letter-spacing:.2px;
      background:linear-gradient(180deg,rgba(201,162,77,.18),rgba(201,162,77,.10));border-bottom:1px solid rgba(255,255,255,.08)}
    summary.dropdownSummary::-webkit-details-marker{display:none}
    .dropdownBody{padding:10px 12px}

    /* ===== calendar views (Walk + Weight) ===== */
    .calTop{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    .calTop .small{margin:0}
    .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .calDow{font-size:11px;color:rgba(143,163,184,.95);font-weight:950;text-align:center;padding:6px 0}
    .calCell{position:relative;min-height:56px;border-radius:12px;
      background:rgba(0,0,0,.14);border:1px solid rgba(255,255,255,.10);
      padding:8px 8px 10px;cursor:pointer;overflow:hidden}
    .calCell.off{opacity:.45}
    .calDay{font-family:var(--mono);font-size:12px;color:rgba(232,238,246,.92);font-weight:950}
    .calVal{margin-top:6px;font-size:11px;color:rgba(201,162,77,.95);font-weight:900}
    .calSub{margin-top:2px;font-size:11px;color:rgba(143,163,184,.92)}
    .calDel{position:absolute;top:6px;right:6px;border-radius:10px;padding:4px 7px;font-size:11px;line-height:1;
      background:rgba(255,107,107,.14);border:1px solid rgba(255,107,107,.35);color:rgba(232,238,246,.95)}

  </style>
</head>

<body>
<header>
  <div class="top">
    <h1><span class="dot"></span>WalkCut <span class="pill" id="todayPill"></span></h1>
    <span class="pill" id="streakPill">Streaks: —</span>
  </div>
</header>

<main>
  <!-- DASH -->
  <section id="view-dash" class="grid">
    <div class="card">
      <h2>Today’s Targets</h2>
      <div class="kpi" id="walkTargets"></div>

      <div class="divider"></div>
      <div class="row">
        <div class="small">Walk progress (current vs goal)</div>
        <div class="small mono" id="walkProgressText">—</div>
      </div>
      <div class="progress"><div id="walkProgressBar"></div></div>

      
      <div class="divider"></div>
      <details class="dropdown" id="nonComplianceDropdown">
        <summary class="dropdownSummary">Compliance</summary>
        <div class="dropdownBody">
          <div class="row">
            <div class="small">Compliance (today)</div>
            <select id="complianceSel" style="max-width:140px">
              <option value="">—</option>
              <option value="yes">Yes</option>
              <option value="no">No</option>
            </select>
          </div>

          <div class="small mono" id="todayCompliance" style="margin-top:8px">—</div>

          <div id="reasonWrap" style="display:none">
            <div class="divider"></div>
            <label style="margin-top:10px">Reason (if No)</label>
            <textarea id="reasonText" placeholder="Example: travel day, sick, shift ran late, etc."></textarea>
            <div class="btnbar" style="margin-top:10px">
              <button id="saveReason" type="button">Save reason</button>
              <button class="secondary" id="clearReason" type="button">Clear</button>
            </div>
          </div>
        </div>
      </details>
    </div>

    <div class="card">
      <h2>Macros Today (grams)</h2>
      <div class="kpi" id="macroKPIsDash"></div>

      <div class="mwrap">
        <div class="mrow">
          <div class="mname">Protein</div>
          <div class="mbar"><div id="barP"></div></div>
          <div class="mpct mono" id="pctP">—</div>
        </div>
        <div class="mrow">
          <div class="mname">Carbs</div>
          <div class="mbar"><div id="barC"></div></div>
          <div class="mpct mono" id="pctC">—</div>
        </div>
        <div class="mrow">
          <div class="mname">Fat</div>
          <div class="mbar"><div id="barF"></div></div>
          <div class="mpct mono" id="pctF">—</div>
        </div>
      </div>

      <div class="divider"></div>
      <div class="row">
        <div class="small">Calories</div>
        <div class="small mono" id="calorieLineDash">—</div>
      </div>

      <div class="divider"></div>
      <div class="small"></div>
    </div>

    <div class="card">
      <h2>Walks This Week (Mon–Sun)</h2>
      <canvas id="walkWeekBars"></canvas>
      <div class="divider"></div>
      <div class="small">Bars = miles logged each day.</div>
    </div>

    <div class="card">
      <h2>Weight Trend</h2>
      <canvas id="weightChart"></canvas>
      <div class="divider"></div>
      <div class="small"></div>
    </div>

    <div class="card">
      <h2>Compliance</h2>
      <div class="row" style="margin-bottom:8px">
        <div class="small">View</div>
        <select id="compViewSel" style="max-width:180px">
          <option value="weekly">Weekly (8 weeks)</option>
          <option value="daily">Daily (last 21 days)</option>
        </select>
      </div>
      <canvas id="weeklyComplianceChart"></canvas>
      <div class="divider"></div>
      <div class="small">A day counts as compliant only if Walk + Macros are both ≥90%.</div>
    </div>
  </section>

  <!-- WALK -->
  <section id="view-walk" class="grid" style="display:none">
    <div class="card">
      <h2>Log Walking</h2>
      <label>Date</label>
      <input type="date" id="walkDate">
      <div class="grid two">
        <div>
          <label>Miles</label>
          <input inputmode="decimal" placeholder="e.g., 3.2" id="walkMiles">
        </div>
        <div>
          <label>Minutes</label>
          <input inputmode="numeric" placeholder="e.g., 55" id="walkMinutes">
        </div>
      </div>
      <div class="btnbar" style="margin-top:12px">
        <button id="saveWalk" type="button">Save</button>
        <button class="secondary" id="backFromWalk" type="button">Back</button>
      </div>
      <div class="divider"></div>
      <div class="small">If you only know minutes, leave miles blank (it estimates from pace).</div>
    </div>

    <div class="card">
      <h2>Walk Logs (Calendar)</h2>
      <div class="calTop">
        <div class="small">Tap a day to load it into the form. Use ✕ to delete.</div>
        <select id="walkMonthSel" style="max-width:220px"></select>
      </div>
      <div class="calGrid" id="walkCalDow"></div>
      <div class="calGrid" id="walkCal"></div>
    </div>
  </section>

  <!-- MACROS -->
  <section id="view-macros" class="grid" style="display:none">
    <div class="card">
      <h2>Macros Today (grams)</h2>
      <div class="kpi" id="macroKPIs2"></div>

      <div class="mwrap">
        <div class="mrow"><div class="mname">Protein</div><div class="mbar"><div id="barP2"></div></div><div class="mpct mono" id="pctP2">—</div></div>
        <div class="mrow"><div class="mname">Carbs</div><div class="mbar"><div id="barC2"></div></div><div class="mpct mono" id="pctC2">—</div></div>
        <div class="mrow"><div class="mname">Fat</div><div class="mbar"><div id="barF2"></div></div><div class="mpct mono" id="pctF2">—</div></div>
<div class="divider"></div>
<h2 style="margin-top:0">Carbs ⇄ Fat (daily balance)</h2>
<div class="small">Slide to trade carbs for fat while keeping <b>protein + total calories</b> the same. Center = <b>200g carbs / 69g fat</b>.</div>

<div class="mini" style="margin-top:10px">
  <div class="row">
    <div class="small">more fat / less carb</div>
    <div class="small mono" id="cfBalanceLabel">0g</div>
    <div class="small">less fat / more carb</div>
  </div>
  <input type="range" id="cfBalance" min="-150" max="150" step="1" value="0">
  <div class="row" style="margin-top:8px">
    <div class="small mono" id="cfTargetsLine">—</div>
    <button class="secondary" id="resetBalance" type="button">Reset</button>
  </div>
</div>

      </div>

      <div class="divider"></div>
      <div class="row">
        <div class="small">Calories (target / eaten)</div>
        <div class="small mono" id="calorieLine2">—</div>
      </div>

      <div class="divider"></div>
      <div class="btnbar">
        <button id="btnOpenEntry" type="button">Add Food Entry</button>
        <button class="secondary" id="btnOpenFood" type="button">Add Food</button>
      </div>
    </div>

    <div class="card" id="entryCard" style="display:none">
      <h2>Add Food Entry</h2>

      <label>Meal</label>
      <select id="mealSel">
        <option value="breakfast">Breakfast</option>
        <option value="lunch">Lunch</option>
        <option value="dinner">Dinner</option>
        <option value="snack">Snack</option>
      </select>

      <label>Protein</label>
      <select id="foodSelProtein"></select>

      <label>Grains</label>
      <select id="foodSelGrains"></select>

      <label>Fruits & Vegetables</label>
      <select id="foodSelFv"></select>

      <div class="divider"></div>
      <label>Which dropdown did you pick?</label>
      <select id="pickedGroup">
        <option value="protein">Protein</option>
        <option value="grains">Grains</option>
        <option value="fruitsveg">Fruits & Vegetables</option>
      </select>

      <label>Ounces eaten (oz)</label>
      <input inputmode="decimal" placeholder="e.g., 6" id="entryOz">

      <div class="btnbar" style="margin-top:12px">
        <button id="saveEntry" type="button">Save Entry</button>
        <button class="secondary" id="closeEntry" type="button">Close</button>
        <button class="secondary" id="clearEntry" type="button">Clear</button>
      </div>

      <div class="divider"></div>
      <div class="small">Foods are per <b>4 oz</b>. Entry scales by (oz ÷ 4).</div>
    </div>

    <div class="card">
      <h2>Today’s Food Log</h2>
      <div id="todayFoodLog"></div>
    </div>

    <div class="card" id="addFoodCard" style="display:none">
      <h2>Add Food (macros per 4 oz)</h2>

      <label>Category</label>
      <select id="foodCat">
        <option value="protein">Protein</option>
        <option value="grains">Grains</option>
        <option value="fruitsveg">Fruits & Vegetables</option>
      </select>

      <label>Name</label>
      <input id="foodName" placeholder="e.g., Chicken breast (cooked)">

      <label>Protein grams per 4 oz</label>
      <input id="foodP" inputmode="decimal" placeholder="e.g., 35">

      <label>Carb grams per 4 oz</label>
      <input id="foodC" inputmode="decimal" placeholder="e.g., 0">

      <label>Fat grams per 4 oz</label>
      <input id="foodF" inputmode="decimal" placeholder="e.g., 4">

      <div class="btnbar" style="margin-top:12px">
        <button id="saveFood" type="button">Save Food</button>
        <button class="secondary" id="hideAddFood" type="button">Close</button>
      </div>
    </div>
  </section>

  <!-- WEIGHT -->
  <section id="view-weight" class="grid" style="display:none">
    <div class="card">
      <h2>Log Weight</h2>
      <label>Date</label>
      <input type="date" id="wDate">
      <label>Weight (lb)</label>
      <input inputmode="decimal" placeholder="e.g., 225.0" id="wLb">
      <div class="btnbar" style="margin-top:12px">
        <button id="saveWeight" type="button">Save</button>
        <button class="secondary" id="backFromWeight" type="button">Back</button>
      </div>
    </div>

    <div class="card">
      <h2>Weight Entries (Calendar)</h2>
      <div class="calTop">
        <div class="small">Tap a day to load it into the form. Use ✕ to delete.</div>
        <select id="weightMonthSel" style="max-width:220px"></select>
      </div>
      <div class="calGrid" id="weightCalDow"></div>
      <div class="calGrid" id="weightCal"></div>
    </div>
  </section>

  <!-- SETUP -->
  <section id="view-setup" class="grid" style="display:none">
    <div class="card">
      <h2>Profile</h2>
      <div class="grid two">
        <div><label>Age</label><input inputmode="numeric" id="pAge" placeholder="44"></div>
        <div><label>Height (inches)</label><input inputmode="numeric" id="pHeight" placeholder="73"><div class="small">6'1" = 73 inches</div></div>
      </div>
      <div class="grid two">
        <div><label>Weight (lb)</label><input inputmode="decimal" id="pWeight" placeholder="225"></div>
        <div><label>Goal loss (lb)</label><input inputmode="decimal" id="pGoalLoss" placeholder="30"></div>
      </div>
    </div>

    <div class="card">
      <h2>Walking Plan</h2>
      <label>Weight loss goal (lb/week)</label>
      <select id="lossRate">
        <option value="0.5">0.5</option>
        <option value="1.0" selected>1.0</option>
        <option value="1.5">1.5</option>
      </select>

      <label>Walking pace</label>
      <select id="pace">
        <option value="3.0">3.0 mph</option>
        <option value="3.5" selected>3.5 mph</option>
        <option value="4.0">4.0 mph</option>
      </select>

      <label>Walking share of deficit (%)</label>
      <input type="range" id="walkShare" min="0" max="100" step="5" value="70">
      <div class="row"><div class="small">diet</div><div class="small mono" id="walkShareLabel">70%</div><div class="small">walk</div></div>

      <div class="divider"></div>
      <div class="small">
        Auto-adjust: if your last 7-day loss is less than your goal, WalkCut tightens calories by 6% (only if 7-day compliance ≥90%).
      </div>
    </div>

    <div class="card">
      <h2>Nutrition Plan</h2>

      <label><input type="checkbox" id="autoTargets" checked> Auto macro targets</label>

      <div class="grid two" id="autoTargetsBox">
        <div>
          <label>Protein per lb of goal weight</label>
          <input inputmode="decimal" id="protPerLb" placeholder="1.01">
          <div class="small">Default = 1.01</div>
        </div>
        <div>
          <label>Fat per lb of goal weight</label>
          <input inputmode="decimal" id="fatPerLb" placeholder="0.30">
        </div>
      </div>

      <div id="customTargetsBox" style="display:none">
        <div class="grid three">
          <div><label>Protein (g)</label><input inputmode="decimal" id="custP" placeholder="180"></div>
          <div><label>Carbs (g)</label><input inputmode="decimal" id="custC" placeholder="200"></div>
          <div><label>Fat (g)</label><input inputmode="decimal" id="custF" placeholder="69"></div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="divider"></div>
      <div class="small mono" id="macroPreview">—</div>
      <div class="small mono" id="autoAdjustStatus" style="margin-top:8px">—</div>
    </div>

    <div class="card">
      <h2>Daily Reminder</h2>
      <div class="small">In-app reminder only: shows when WalkCut is open within 30 minutes after your time.</div>
      <label><input type="checkbox" id="remEnabled"> Enable reminder</label>
      <div class="grid two">
        <div><label>Hour (0–23)</label><input inputmode="numeric" id="remHour" placeholder="19"></div>
        <div><label>Minute (0–59)</label><input inputmode="numeric" id="remMin" placeholder="0"></div>
      </div>
      <div class="btnbar" style="margin-top:12px">
        <button id="testReminder" type="button">Test reminder</button>
      </div>
    </div>

    <div class="card">
      <h2>Save</h2>
      <div class="btnbar">
        <button id="saveSetup" type="button">Save Setup</button>
        <button class="secondary" id="backFromSetup" type="button">Back</button>
        <button class="danger" id="resetAll" type="button">Reset all data</button>
      </div>
      <div class="divider"></div>
      <div class="small">Reset wipes everything stored on this device for WalkCut.</div>
    </div>
  </section>
</main>

<div id="toast" role="status" aria-live="polite"></div>

<nav class="tabs" aria-label="navigation">
  <button class="tab active" type="button" data-tab="dash">Dashboard</button>
  <button class="tab" type="button" data-tab="walk">Walk</button>
  <button class="tab" type="button" data-tab="macros">Macros</button>
  <button class="tab" type="button" data-tab="weight">Weight</button>
  <button class="tab" type="button" data-tab="setup">Setup</button>
</nav>

<script>
/* WalkCut — single-file
   - Macros in grams; foods are per 4oz
   - Dashboard macro bars: blue <80%, green 80–100%, red >100%
   - Weekly walks bar chart (Mon–Sun)
   - Compliance: requires Walk + Macros both >=90%
   - Compliance % shown; reason logging for non-compliance
   - Auto-adjust macros (tighten calories) only if 7-day compliance >=90% and weight loss is stagnant vs goal
   - Reminder is in-app toast only
*/

const LS_KEY = "walkcut_v2";

/* ===== safe clone ===== */
function safeClone(obj){
  if (typeof structuredClone === "function") return structuredClone(obj);
  return JSON.parse(JSON.stringify(obj));
}

/* ===== utils ===== */
function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function round(n, d=1){ const p=Math.pow(10,d); return Math.round(n*p)/p; }
function todayISO(d=new Date()){
  const x=new Date(d.getFullYear(), d.getMonth(), d.getDate());
  return x.toISOString().slice(0,10);
}
function parseNum(v){
  if(v==null) return 0;
  const s=(""+v).trim().replace(",",".");
  const n=Number(s);
  return Number.isFinite(n) ? n : 0;
}
function caloriesFromMacros(p,c,f){ return p*4 + c*4 + f*9; }
function escapeHtml(s){
  return (""+s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}
function capitalize(s){ return (""+s).charAt(0).toUpperCase() + (""+s).slice(1); }
function startOfWeekMonday(d){
  const x=new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const day=(x.getDay()+6)%7; // Mon=0..Sun=6
  x.setDate(x.getDate()-day);
  return x;
}


function ymFromISO(iso){ return (iso||"").slice(0,7); }
function monthLabel(ym){
  if(!ym || ym.length<7) return ym || "";
  const y=parseInt(ym.slice(0,4),10);
  const m=parseInt(ym.slice(5,7),10)-1;
  const d=new Date(y,m,1);
  return d.toLocaleDateString(undefined,{ month:"long", year:"numeric" });
}
function mondayIndex(jsDay){ return (jsDay + 6) % 7; } // Mon=0..Sun=6
function buildMonthGrid(ym){
  const y=parseInt(ym.slice(0,4),10);
  const m=parseInt(ym.slice(5,7),10)-1;
  const first=new Date(y,m,1);
  const offset=mondayIndex(first.getDay());
  const start=new Date(y,m,1-offset);
  const cells=[];
  for(let i=0;i<42;i++){
    const d=new Date(start); d.setDate(start.getDate()+i);
    cells.push({
      iso: todayISO(d),
      day: d.getDate(),
      inMonth: d.getMonth()===m,
    });
  }
  return cells;
}
function renderDowGrid(el){
  if(!el) return;
  el.innerHTML = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"].map(x=>`<div class="calDow">${x}</div>`).join("");
}



/* ===== toast ===== */
let toastTimer=null;
function toast(msg, sub=""){
  const el=document.getElementById("toast");
  if(!el) return;
  el.innerHTML = `${escapeHtml(msg)}${sub?`<span class="sub">${escapeHtml(sub)}</span>`:""}`;
  el.style.display="block";
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{ el.style.display="none"; }, 4500);
}

/* ===== defaults ===== */
const defaults = {
  profile: { age:44, heightIn:73, weightLb:225, goalLossLb:30 },
  plan: { lossRateLbWk:1.0, paceMph:3.5, walkShare:0.70 },
  nutrition: {
    autoTargets:true,
    protPerLbGoal:1.01,     // requested default
    fatPerLbGoal:0.30,
    custom:{ p:180, c:200, f:69 }, // grams
    overrides:{ carbs:200, fat:null, mode:"carbs", balance:0 }, // carb/fat tuning (balance slider)
    calAdjustFactor:1.00,   // auto-adjust multiplier (tightens cals)
    reminder:{ enabled:false, hour:19, minute:0, lastFired:"" }
  },
  foods: [
    // macros PER 4 oz of FOOD, stored as grams
    { id:uid(), cat:"protein",  name:"Chicken breast (cooked)", p:35, c:0,  f:4  },
    { id:uid(), cat:"grains",   name:"Rice (cooked)",           p:4,  c:45, f:0.5},
    { id:uid(), cat:"fruitsveg",name:"Greek yogurt (plain)",    p:12, c:6,  f:0  }
  ],
  foodEntries: [], // {id, day, meal, foodId, oz, ts}
  walkLogs: [],    // {day, miles, minutes}
  weights: [],     // {day, lb}
  ui: { complianceView:"weekly" },
  reasons: {}      // { "YYYY-MM-DD": "text" }
};

let state = loadState();

let compliancePts=[];


/* ===== persistence ===== */
function deepMerge(target, src){
  for(const k in src){
    if(src[k] && typeof src[k]==="object" && !Array.isArray(src[k])){
      if(!target[k] || typeof target[k]!=="object") target[k]={};
      deepMerge(target[k], src[k]);
    }else{
      target[k]=src[k];
    }
  }
}
function loadState(){
  try{
    const raw=localStorage.getItem(LS_KEY);
    if(!raw) return safeClone(defaults);
    const s=JSON.parse(raw);
    const merged=safeClone(defaults);
    deepMerge(merged, s);

    if(!Array.isArray(merged.foods) || merged.foods.length===0) merged.foods=safeClone(defaults.foods);
    merged.foods = merged.foods.map(f=>({ ...f, id: f.id || uid(), cat: f.cat || "protein" }));

    merged.nutrition = merged.nutrition || safeClone(defaults.nutrition);
    merged.nutrition.overrides = merged.nutrition.overrides || safeClone(defaults.nutrition.overrides);
    if(merged.nutrition.overrides.cfBalance == null) merged.nutrition.overrides.cfBalance = 0;
    if(merged.nutrition.overrides.carbs == null) merged.nutrition.overrides.carbs = 200;
    if(!merged.nutrition.overrides.mode) merged.nutrition.overrides.mode = "carbs";
    merged.nutrition.reminder = merged.nutrition.reminder || safeClone(defaults.nutrition.reminder);
    if(!merged.ui) merged.ui = safeClone(defaults.ui);
    if(!merged.ui.complianceView) merged.ui.complianceView = "weekly";
    if(!merged.ui.weightMonth) merged.ui.weightMonth = todayISO().slice(0,7);
    if(!merged.ui.walkMonth) merged.ui.walkMonth = todayISO().slice(0,7);
    if(!merged.reasons) merged.reasons = {};

    return merged;
  }catch(e){
    return safeClone(defaults);
  }
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  renderAll();
}

/* ===== core calculations ===== */
function stepsPerMile(heightIn){ return clamp(2100 + (73 - heightIn) * 15, 1700, 2600); }
function kcalPerMile(weightLb, paceMph){
  const baseByPace = paceMph <= 3.05 ? 118 : (paceMph <= 3.75 ? 150 : 170);
  return baseByPace * (weightLb / 225.0);
}
function walkTargets(){
  const p=state.profile, plan=state.plan;
  const dailyDef = (plan.lossRateLbWk * 3500) / 7;
  const walkKcal = dailyDef * plan.walkShare;
  const kpm = kcalPerMile(p.weightLb, plan.paceMph);
  const miles = walkKcal / Math.max(1, kpm);
  const minutes = (miles / plan.paceMph) * 60;
  const steps = miles * stepsPerMile(p.heightIn);
  return { dailyDef, walkKcal, kpm, miles, minutes, steps };
}
function tdeeEstimate(){
  const p=state.profile;
  const kg = p.weightLb * 0.45359237;
  const cm = p.heightIn * 2.54;
  const age = p.age;
  const bmr = (10*kg)+(6.25*cm)-(5*age)+5;
  return bmr * 1.35; // heuristic
}
function baseMacroTargets(){
  // produces baseline targets (before overrides & calAdjustFactor)
  const p=state.profile, plan=state.plan, n=state.nutrition;

  if(!n.autoTargets){
    const kcal = caloriesFromMacros(n.custom.p, n.custom.c, n.custom.f);
    return { pG:n.custom.p, cG:n.custom.c, fG:n.custom.f, kcal };
  }

  const goalWeight = Math.max(120, p.weightLb - p.goalLossLb);
  const proteinG = goalWeight * n.protPerLbGoal;
  const fatG = goalWeight * n.fatPerLbGoal;

  const dailyDef = (plan.lossRateLbWk * 3500) / 7;
  const deficitFromFood = dailyDef * (1 - plan.walkShare);

  let calTarget = Math.max(1500, tdeeEstimate() - deficitFromFood);

  // apply auto-adjust factor
  calTarget = calTarget * clamp(n.calAdjustFactor || 1.0, 0.80, 1.10);

  const used = proteinG*4 + fatG*9;
  const carbsG = Math.max(0, (calTarget - used) / 4);
  return { pG:proteinG, cG:carbsG, fG:fatG, kcal: caloriesFromMacros(proteinG, carbsG, fatG) };
}
function macroTargets(){
  // Carbs ⇄ Fat balance slider takes precedence when set.
  // It trades carbs for fat while keeping protein + total calories constant.
  const n = state.nutrition;
  const base = baseMacroTargets();

  const P = base.pG;

  const hasBalance = n.overrides && n.overrides.cfBalance != null && n.overrides.cfBalance !== "";
  if(hasBalance){
    const BAL_CARBS_CENTER = 200;
    const BAL_FAT_CENTER   = 69;
    const delta = clamp(parseNum(n.overrides.cfBalance), -150, 150);

    const kcalTarget = (P*4) + (BAL_CARBS_CENTER*4) + (BAL_FAT_CENTER*9);

    const C = Math.max(0, BAL_CARBS_CENTER + delta);
    const F = Math.max(0, (kcalTarget - (P*4) - (C*4)) / 9);

    return { pG:P, cG:C, fG:F, kcal: caloriesFromMacros(P,C,F) };
  }

  // Otherwise, use classic carb/fat overrides while keeping calories stable (protein fixed).
  const mode = n.overrides?.mode || "carbs";
  const hasCarbOverride = n.overrides && n.overrides.carbs != null && n.overrides.carbs !== "";
  const hasFatOverride  = n.overrides && n.overrides.fat  != null && n.overrides.fat  !== "";
  const carbO = hasCarbOverride ? parseNum(n.overrides.carbs) : null;
  const fatO  = hasFatOverride  ? parseNum(n.overrides.fat)  : null;

  const kcalTarget = base.kcal;
  let C = base.cG;
  let F = base.fG;

  const remainingKcal = Math.max(0, kcalTarget - P*4);

  if(mode === "carbs" && carbO != null){
    C = Math.max(0, carbO);
    const kcalLeftForFat = Math.max(0, remainingKcal - C*4);
    F = kcalLeftForFat / 9;
  }else if(mode === "fat" && fatO != null){
    F = Math.max(0, fatO);
    const kcalLeftForCarbs = Math.max(0, remainingKcal - F*9);
    C = kcalLeftForCarbs / 4;
  }

  return { pG:P, cG:Math.max(0,C), fG:Math.max(0,F), kcal: caloriesFromMacros(P,Math.max(0,C),Math.max(0,F)) };
}


/* ===== logs ===== */
function entriesForDay(dayISO){ return state.foodEntries.filter(e=>e.day===dayISO); }
function walkLogForDay(dayISO){ return state.walkLogs.find(w=>w.day===dayISO) || null; }
function weightForDay(dayISO){ return state.weights.find(w=>w.day===dayISO) || null; }

/* Foods are per 4 oz, entries are oz. multiplier = oz/4 */
function macroConsumed(dayISO){
  let p=0,c=0,f=0;
  for(const e of entriesForDay(dayISO)){
    const food = state.foods.find(x=>x.id===e.foodId);
    if(!food) continue;
    const mult = (e.oz || 0) / 4.0;
    p += food.p * mult;
    c += food.c * mult;
    f += food.f * mult;
  }
  return { pG:p, cG:c, fG:f, kcal: caloriesFromMacros(p,c,f) };
}

/* ===== compliance rules =====
   - Macro compliance: each macro % computed vs target. For "compliance day" we use:
     protein >= 90% target AND calories between 70% and 110% target (same as earlier)
   - Walk compliance: miles >= 90% of target miles
   - Day compliant: walk AND macros both true
*/
function macroCompliant(dayISO){
  const t=macroTargets();
  const a=macroConsumed(dayISO);
  const proteinOK = a.pG >= t.pG * 0.90;
  const calOK = (a.kcal >= t.kcal * 0.70) && (a.kcal <= t.kcal * 1.10);
  return proteinOK && calOK;
}
function walkCompliant(dayISO){
  const t=walkTargets();
  const wl=walkLogForDay(dayISO);
  if(!wl) return false;
  return wl.miles >= t.miles * 0.90;
}
function dayCompliant(dayISO){
  return macroCompliant(dayISO) && walkCompliant(dayISO);
}
function todayComplianceText(){
  const iso=todayISO();
  const mc = macroCompliant(iso);
  const wc = walkCompliant(iso);
  const dc = mc && wc;
  const parts = [
    `Walk ${wc ? "OK" : "NO"}`,
    `Macros ${mc ? "OK" : "NO"}`,
    `Day ${dc ? "COMPLIANT" : "NOT"}`
  ];
  return parts.join(" • ");
}
function compliancePctForRange(startISO, days){
  let ok=0;
  for(let i=0;i<days;i++){
    const d=new Date(startISO);
    d.setDate(d.getDate()+i);
    const iso=todayISO(d);
    if(dayCompliant(iso)) ok++;
  }
  return (ok/days)*100;
}

/* ===== streaks ===== */
function computeStreaks(){
  let walkStreak=0, macroStreak=0, dayStreak=0;
  for(let i=0;i<365;i++){
    const d=new Date(); d.setDate(d.getDate()-i);
    const iso=todayISO(d);
    const w=walkCompliant(iso);
    const m=macroCompliant(iso);
    const day=w && m;

    if(i===0){
      walkStreak = w?1:0;
      macroStreak = m?1:0;
      dayStreak = day?1:0;
    }else{
      if(walkStreak===i && w) walkStreak++;
      if(macroStreak===i && m) macroStreak++;
      if(dayStreak===i && day) dayStreak++;
    }
    if(i>21 && walkStreak<i && macroStreak<i && dayStreak<i) break;
  }
  return { walkStreak, macroStreak, dayStreak };
}

/* ===== in-app reminder (toast only) ===== */
function maybeFireReminder(){
  const r=state.nutrition?.reminder;
  if(!r || !r.enabled) return;
  const now=new Date();
  const iso=todayISO(now);
  const minsNow=now.getHours()*60 + now.getMinutes();
  const hour=clamp(parseInt(r.hour,10)||19,0,23);
  const minute=clamp(parseInt(r.minute,10)||0,0,59);
  const minsTarget=hour*60 + minute;
  if(minsNow >= minsTarget && minsNow <= minsTarget+30){
    if(r.lastFired !== iso){
      toast("WalkCut reminder", "Time to hit your walk + macros goals.");
      r.lastFired = iso;
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }
  }
}

/* ===== auto-adjust logic =====
   Stagnant = last 7-day loss < goal lb/week (from setup).
   Only adjust if last-7 compliance >= 90%.
   Adjustment = tighten calories by 6% (calAdjustFactor *= 0.94), capped.
*/
function computeLast7WeightLoss(){
  // uses latest two weights within last 7 days window:
  // if weights exist: loss = (oldest - newest)
  const end = new Date(); // today
  const start = new Date(); start.setDate(end.getDate()-7);

  const rows = state.weights.slice().filter(w=>{
    const d = new Date(w.day);
    return d >= start && d <= end && w.lb>0;
  }).sort((a,b)=> a.day.localeCompare(b.day));

  if(rows.length < 2) return null;
  const oldest = rows[0].lb;
  const newest = rows[rows.length-1].lb;
  return oldest - newest; // positive if loss
}
function autoAdjustIfNeeded(){
  const plan=state.plan;
  const n=state.nutrition;

  const loss = computeLast7WeightLoss();
  const monday = startOfWeekMonday(new Date());
  const comp7 = (() => {
    // last 7 days compliance %
    let ok=0;
    for(let i=0;i<7;i++){
      const d=new Date(); d.setDate(d.getDate()-i);
      if(dayCompliant(todayISO(d))) ok++;
    }
    return (ok/7)*100;
  })();

  let status = `Auto-adjust: waiting for 2+ weigh-ins in the last 7 days. (7-day compliance: ${Math.round(comp7)}%)`;
  if(loss != null){
    status = `7-day loss: ${round(loss,2)} lb vs goal ${round(plan.lossRateLbWk,2)} lb/wk • 7-day compliance: ${Math.round(comp7)}% • Cal adjust: ${Math.round((n.calAdjustFactor||1)*100)}%`;
    const stagnant = loss < plan.lossRateLbWk; // requested definition
    const compliantEnough = comp7 >= 90;

    if(stagnant && compliantEnough){
      // tighten
      const current = clamp(n.calAdjustFactor || 1.0, 0.80, 1.10);
      const next = clamp(current * 0.94, 0.80, 1.10);
      if(next < current - 0.0001){
        n.calAdjustFactor = next;
        saveState();
        toast("Auto-adjust applied", `Calories tightened to ${Math.round(next*100)}% (stagnant + compliant).`);
      }
    }
  }
  const el=document.getElementById("autoAdjustStatus");
  if(el) el.textContent = status;
}

/* ===== charts ===== */
function resizeCanvasForHiDPI(canvas){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  const needW = Math.max(1, Math.round(rect.width * dpr));
  const needH = Math.max(1, Math.round(rect.height * dpr));
  if(canvas.width !== needW || canvas.height !== needH){
    canvas.width = needW;
    canvas.height = needH;
  }
  return { w: canvas.width, h: canvas.height };
}
function drawLine(canvasId, series, opts){
  const canvas=document.getElementById(canvasId);
  if(!canvas) return [];
  const ctx=canvas.getContext("2d");
  const {w,h}=resizeCanvasForHiDPI(canvas);
  ctx.clearRect(0,0,w,h);

  if(!series || series.length<2){
    ctx.fillStyle="rgba(143,163,184,.9)";
    ctx.font = `${Math.round(h*0.09)}px ${getComputedStyle(document.body).fontFamily}`;
    ctx.fillText(opts?.emptyText || "Add entries.", Math.round(w*0.04), Math.round(h*0.22));
    return [];
  }

  const valid = series.filter(s=> Number.isFinite(s.y));
  if(valid.length < 2){
    ctx.fillStyle="rgba(143,163,184,.9)";
    ctx.font = `${Math.round(h*0.09)}px ${getComputedStyle(document.body).fontFamily}`;
    ctx.fillText(opts?.emptyText || "Log some data.", Math.round(w*0.04), Math.round(h*0.22));
    return [];
  }

  const vals=valid.map(s=>s.y);
  let min=Math.min(...vals), max=Math.max(...vals);
  if(max-min < 0.5){ max += 0.25; min -= 0.25; }

  const pad=Math.round(w*0.07);
  const x0=pad, y0=pad, x1=w-pad, y1=h-pad;

  // grid
  ctx.strokeStyle="rgba(255,255,255,.10)";
  ctx.lineWidth=Math.max(1, Math.round(w*0.0015));
  for(let i=0;i<=4;i++){
    const y=y0+(y1-y0)*(i/4);
    ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x1,y); ctx.stroke();
  }

  function X(i){ return x0 + (x1-x0)*(i/(series.length-1)); }
  function Y(v){ return y1 - (y1-y0)*((v-min)/(max-min)); }

  // line (supports gaps when y is null)
  ctx.strokeStyle="rgba(201,162,77,.95)";
  ctx.lineWidth=Math.max(3, Math.round(w*0.004));
  ctx.lineJoin="round"; ctx.lineCap="round";
  ctx.beginPath();
  let started=false;
  series.forEach((p,i)=>{
    if(!Number.isFinite(p.y)){ started=false; return; }
    const x=X(i), y=Y(p.y);
    if(!started){ ctx.moveTo(x,y); started=true; }
    else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // markers + capture points (only for valid points)
  const pts = [];
  series.forEach((p,i)=>{
    if(!Number.isFinite(p.y)) return;
    pts.push({ x:X(i), y:Y(p.y), data:p });
  });

  if(opts?.markers){
    const fs = Math.max(14, Math.round(h*0.10));
    ctx.font = `${fs}px ${getComputedStyle(document.body).fontFamily}`;
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    pts.forEach((pt)=>{
      const d=pt.data || {};
      const hasOk = (d.ok === true || d.ok === false);
      if(!hasOk) return; // leave marker blank until compliance has been tracked
      const isOk = d.ok;
      const mark = isOk ? "*" : "!";
      ctx.fillStyle = isOk ? "rgba(61,220,151,.95)" : "rgba(255,107,107,.95)";
      ctx.fillText(mark, pt.x, pt.y - Math.max(12, Math.round(h*0.05)));
    });
    ctx.textAlign="left";
    ctx.textBaseline="alphabetic";
  }

  // last point dot (last valid point)
  const lastValid = [...series].reverse().find(p=>Number.isFinite(p.y));
  if(lastValid){
    const lastIdx = series.lastIndexOf(lastValid);
    ctx.fillStyle="rgba(58,160,255,.95)";
    ctx.beginPath();
    ctx.arc(X(lastIdx), Y(lastValid.y), Math.max(5, Math.round(w*0.007)), 0, Math.PI*2);
    ctx.fill();
  }

  // title
  if(opts?.title){
    ctx.fillStyle="rgba(232,238,246,.95)";
    ctx.font = `${Math.round(h*0.07)}px ${getComputedStyle(document.body).fontFamily}`;
    ctx.fillText(opts.title, x0, y0 - Math.round(h*0.04));
  }

  return pts;
}

function drawWeekBars(canvasId){
  const canvas=document.getElementById(canvasId);
  if(!canvas) return;
  const ctx=canvas.getContext("2d");
  const {w,h}=resizeCanvasForHiDPI(canvas);
  ctx.clearRect(0,0,w,h);

  const mon=startOfWeekMonday(new Date());
  const days=[];
  for(let i=0;i<7;i++){
    const d=new Date(mon); d.setDate(mon.getDate()+i);
    const iso=todayISO(d);
    const wl=walkLogForDay(iso);
    days.push({ iso, label:["Mon","Tue","Wed","Thu","Fri","Sat","Sun"][i], miles: wl?wl.miles:0 });
  }
  const maxMiles = Math.max(1, ...days.map(d=>d.miles));
  const pad=Math.round(w*0.08);
  const x0=pad, y0=pad, x1=w-pad, y1=h-pad;
  const barW=(x1-x0)/7 * 0.62;
  const gap=(x1-x0)/7;

  // axis baseline
  ctx.strokeStyle="rgba(255,255,255,.12)";
  ctx.lineWidth=Math.max(1, Math.round(w*0.0015));
  ctx.beginPath(); ctx.moveTo(x0,y1); ctx.lineTo(x1,y1); ctx.stroke();

  // bars
  days.forEach((d,i)=>{
    const x = x0 + i*gap + (gap-barW)/2;
    const barH = (d.miles/maxMiles) * (y1-y0);
    const y = y1 - barH;

    ctx.fillStyle = "rgba(58,160,255,.55)";
    ctx.fillRect(x,y,barW,barH);

    // label
    ctx.fillStyle="rgba(143,163,184,.95)";
    ctx.font = `${Math.round(h*0.06)}px ${getComputedStyle(document.body).fontFamily}`;
    ctx.fillText(d.label, x+2, y1 + Math.round(h*0.08));

    // value
    ctx.fillStyle="rgba(232,238,246,.95)";
    ctx.font = `${Math.round(h*0.055)}px ${getComputedStyle(document.body).fontFamily}`;
    ctx.fillText(`${round(d.miles,1)}`, x+2, y - 6);
  });

  // title
  ctx.fillStyle="rgba(232,238,246,.95)";
  ctx.font = `${Math.round(h*0.07)}px ${getComputedStyle(document.body).fontFamily}`;
  ctx.fillText("Miles per day", x0, y0 - Math.round(h*0.04));
}
function buildWeightSeries(maxPoints=90){
  const data=state.weights.slice().sort((a,b)=>a.day.localeCompare(b.day)).slice(-maxPoints);
  return data.map(d=>({ y:d.lb, label:d.day }));
}
function buildWeeklyComplianceSeries(weeksBack=8){
  const out=[];
  const now=new Date();
  const thisMon=startOfWeekMonday(now);
  for(let w=weeksBack-1; w>=0; w--){
    const wkStart=new Date(thisMon); wkStart.setDate(thisMon.getDate()-w*7);
    let ok=0;
    let trackedDays=0;
    for(let i=0;i<7;i++){
      const d=new Date(wkStart); d.setDate(wkStart.getDate()+i);
      const iso=todayISO(d);
      const tracked = !!walkLogForDay(iso) || entriesForDay(iso).length>0;
      if(tracked) trackedDays++;
      if(tracked && dayCompliant(iso)) ok++;
    }
    const pct = trackedDays===0 ? null : (ok/7)*100; // % of full week (7 days) that were compliant
    out.push({ y: pct, label: todayISO(wkStart), ok: (pct===null ? null : (pct>=90)), okDays: ok, trackedDays });
  }
  return out;
}


function buildDailyComplianceSeries(daysBack=21){
  const out=[];
  for(let i=daysBack-1;i>=0;i--){
    const d=new Date(); d.setDate(d.getDate()-i);
    const iso=todayISO(d);

    const tracked = !!walkLogForDay(iso) || entriesForDay(iso).length>0;
    const ok = tracked ? dayCompliant(iso) : null;

    out.push({ y: (ok===null ? null : (ok ? 100 : 0)), label: iso, ok, tracked });
  }
  return out;
}


/* ===== macro bars coloring ===== */
function barColorByPct(pct){
  if(pct > 100) return "rgba(255,107,107,.90)"; // red
  if(pct >= 80) return "rgba(61,220,151,.90)";  // green
  return "rgba(58,160,255,.90)";                // blue
}
function setMacroBar(barEl, pctEl, consumed, target){
  const pct = target>0 ? (consumed/target)*100 : 0;
  const w = clamp(pct, 0, 130);
  barEl.style.width = `${Math.min(100,w)}%`;
  barEl.style.background = barColorByPct(pct);
  pctEl.textContent = `${Math.round(pct)}%`;
}

/* ===== DOM helpers ===== */
function kpiBox(label, value){
  const d=document.createElement("div");
  d.className="box";
  d.innerHTML = `<div class="label">${escapeHtml(label)}</div><div class="value mono">${escapeHtml(value)}</div>`;
  return d;
}
function bindTap(elOrId, fn){
  const el = typeof elOrId === "string" ? document.getElementById(elOrId) : elOrId;
  if(!el) return;
  const go = (e)=>{ if(e) e.preventDefault(); fn(); };
  el.addEventListener("click", go);
  el.addEventListener("touchstart", go, { passive:false });
}

/* ===== rendering ===== */
function renderHeader(){
  document.getElementById("todayPill").textContent =
    new Date().toLocaleDateString(undefined,{ weekday:"short", month:"short", day:"numeric" });

  const s=computeStreaks();
  document.getElementById("streakPill").textContent =
    `Streaks: Walk ${s.walkStreak} • Macros ${s.macroStreak} • Day ${s.dayStreak}`;
}
function renderWalkTargets(){
  const t=walkTargets();
  const el=document.getElementById("walkTargets");
  el.innerHTML="";
  el.appendChild(kpiBox("Miles", round(t.miles,1)));
  el.appendChild(kpiBox("Minutes", Math.round(t.minutes)));
  el.appendChild(kpiBox("Steps", Math.round(t.steps)));

  const iso=todayISO();
  const wl=walkLogForDay(iso);
  const logged=wl?wl.miles:0;
  const pct=clamp((logged/Math.max(0.01,t.miles))*100,0,130);
  document.getElementById("walkProgressBar").style.width = `${Math.min(100,pct)}%`;
  document.getElementById("walkProgressText").textContent =
    `${round(logged,1)} / ${round(t.miles,1)} mi (${Math.round(pct)}%)`;
}
function renderMacroDash(){
  const t=macroTargets();
  const a=macroConsumed(todayISO());

  // KPI boxes must be grams (P/C/F)
  const kpi=document.getElementById("macroKPIsDash");
  kpi.innerHTML="";
  kpi.appendChild(kpiBox("Protein (g)", Math.round(a.pG)));
  kpi.appendChild(kpiBox("Carbs (g)", Math.round(a.cG)));
  kpi.appendChild(kpiBox("Fat (g)", Math.round(a.fG)));

  // bars
  setMacroBar(document.getElementById("barP"), document.getElementById("pctP"), a.pG, t.pG);
  setMacroBar(document.getElementById("barC"), document.getElementById("pctC"), a.cG, t.cG);
  setMacroBar(document.getElementById("barF"), document.getElementById("pctF"), a.fG, t.fG);

  document.getElementById("calorieLineDash").textContent =
    `${Math.round(t.kcal)} target • ${Math.round(a.kcal)} eaten`;
}
function renderMacroPage(){
  const t=macroTargets();
  const a=macroConsumed(todayISO());

  const kpi=document.getElementById("macroKPIs2");
  kpi.innerHTML="";
  kpi.appendChild(kpiBox("Protein (g)", `${Math.round(a.pG)} / ${Math.round(t.pG)}`));
  kpi.appendChild(kpiBox("Carbs (g)", `${Math.round(a.cG)} / ${Math.round(t.cG)}`));
  kpi.appendChild(kpiBox("Fat (g)", `${Math.round(a.fG)} / ${Math.round(t.fG)}`));

  setMacroBar(document.getElementById("barP2"), document.getElementById("pctP2"), a.pG, t.pG);
  setMacroBar(document.getElementById("barC2"), document.getElementById("pctC2"), a.cG, t.cG);
  setMacroBar(document.getElementById("barF2"), document.getElementById("pctF2"), a.fG, t.fG);

  document.getElementById("calorieLine2").textContent =
    `${Math.round(t.kcal)} / ${Math.round(a.kcal)}`;
}
function renderCompliance(){
  const iso=todayISO();
  const todayLine = document.getElementById("todayCompliance");
  if(todayLine) todayLine.textContent = todayComplianceText();

  const reason = (state.reasons && state.reasons[iso]) ? state.reasons[iso] : "";

  const sel = document.getElementById("complianceSel");
  const wrap = document.getElementById("reasonWrap");
  const ta = document.getElementById("reasonText");

  if(sel){
    // Do NOT assume "Yes" by default. Only set to "No" if a reason is saved.
    sel.value = reason ? "no" : "";
  }
  if(ta) ta.value = reason || "";
  if(wrap){
    wrap.style.display = (sel && sel.value === "no") ? "" : "none";
  }
}
function renderFoodsDropdowns(){
  const pSel=document.getElementById("foodSelProtein");
  const gSel=document.getElementById("foodSelGrains");
  const fSel=document.getElementById("foodSelFv");
  if(!pSel||!gSel||!fSel) return;

  const byCat = { protein:[], grains:[], fruitsveg:[] };
  for(const f of state.foods){
    (byCat[f.cat] || byCat.protein).push(f);
  }
  function fill(sel, arr){
    sel.innerHTML="";
    const opt0=document.createElement("option");
    opt0.value="";
    opt0.textContent="— Select —";
    sel.appendChild(opt0);
    arr.forEach(x=>{
      const opt=document.createElement("option");
      opt.value=x.id;
      opt.textContent=x.name;
      sel.appendChild(opt);
    });
  }
  fill(pSel, byCat.protein);
  fill(gSel, byCat.grains);
  fill(fSel, byCat.fruitsveg);
}
function renderTodayFoodLog(){
  const out=document.getElementById("todayFoodLog");
  const iso=todayISO();
  const rows=entriesForDay(iso).slice().sort((a,b)=>(b.ts||0)-(a.ts||0));
  if(rows.length===0){
    out.innerHTML = `<div class="small">No entries yet.</div>`;
    return;
  }
  out.innerHTML = rows.map(e=>{
    const food=state.foods.find(x=>x.id===e.foodId);
    const name=food?food.name:"Unknown";
    const mult=(e.oz||0)/4;
    return `
      <div class="row" style="padding:10px 0;border-bottom:1px solid rgba(255,255,255,.08)">
        <div>
          <div style="font-weight:950">${escapeHtml(name)}</div>
          <div class="small">${capitalize(e.meal)} • ${round(e.oz,1)} oz (${round(mult,2)}×)</div>
        </div>
        <div class="btnbar">
          <button class="danger" type="button" data-del-entry="${e.id}">Delete</button>
        </div>
      </div>
    `;
  }).join("");
  out.querySelectorAll("[data-del-entry]").forEach(btn=>{
    bindTap(btn, ()=>{ deleteEntry(btn.getAttribute("data-del-entry")); });
  });
}
function renderWalkCalendar(){
  const sel=document.getElementById("walkMonthSel");
  const dow=document.getElementById("walkCalDow");
  const cal=document.getElementById("walkCal");
  if(!sel||!cal||!dow) return;

  if(!state.ui) state.ui={};
  const currentYM = ymFromISO(todayISO());
  const months = new Set(state.walkLogs.map(w=>ymFromISO(w.day)));
  months.add(currentYM);
  const list=[...months].filter(Boolean).sort((a,b)=>b.localeCompare(a));

  sel.innerHTML = list.map(ym=>`<option value="${ym}">${monthLabel(ym)}</option>`).join("");
  const chosen = (state.ui.walkMonth && list.includes(state.ui.walkMonth)) ? state.ui.walkMonth : currentYM;
  state.ui.walkMonth = chosen;
  sel.value = chosen;

  renderDowGrid(dow);

  const cells = buildMonthGrid(chosen);
  const byDay = {};
  state.walkLogs.forEach(w=>{ byDay[w.day]=w; });

  cal.innerHTML = cells.map(c=>{
    const wl = byDay[c.iso];
    const has = !!wl;
    const miles = has ? round(wl.miles,1) : "";
    const mins  = has ? Math.round(wl.minutes||0) : "";
    return `
      <div class="calCell ${c.inMonth?"":"off"}" data-walk-iso="${c.iso}">
        ${has ? `<button class="calDel" type="button" data-del-walk="${c.iso}">✕</button>` : ""}
        <div class="calDay">${c.day}</div>
        ${has ? `<div class="calVal mono">${miles} mi</div><div class="calSub mono">${mins} min</div>` : ""}
      </div>
    `;
  }).join("");

  // cell tap loads date into form
  cal.querySelectorAll("[data-walk-iso]").forEach(cell=>{
    cell.addEventListener("click", (e)=>{
      const iso = cell.getAttribute("data-walk-iso");
      const wl = byDay[iso] || null;
      const dEl=document.getElementById("walkDate");
      const mEl=document.getElementById("walkMiles");
      const minEl=document.getElementById("walkMinutes");
      if(dEl) dEl.value = iso;
      if(mEl) mEl.value = wl ? (wl.miles ?? "") : "";
      if(minEl) minEl.value = wl ? (wl.minutes ?? "") : "";
      toast("Walk loaded", iso);
    });
  });

  // delete buttons
  cal.querySelectorAll("[data-del-walk]").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      e.preventDefault(); e.stopPropagation();
      deleteWalk(btn.getAttribute("data-del-walk"));
    });
  });
}
function renderWeightCalendar(){
  const sel=document.getElementById("weightMonthSel");
  const dow=document.getElementById("weightCalDow");
  const cal=document.getElementById("weightCal");
  if(!sel||!cal||!dow) return;

  if(!state.ui) state.ui={};
  const currentYM = ymFromISO(todayISO());
  const months = new Set(state.weights.map(w=>ymFromISO(w.day)));
  months.add(currentYM);
  const list=[...months].filter(Boolean).sort((a,b)=>b.localeCompare(a));

  sel.innerHTML = list.map(ym=>`<option value="${ym}">${monthLabel(ym)}</option>`).join("");
  const chosen = (state.ui.weightMonth && list.includes(state.ui.weightMonth)) ? state.ui.weightMonth : currentYM;
  state.ui.weightMonth = chosen;
  sel.value = chosen;

  renderDowGrid(dow);

  const cells = buildMonthGrid(chosen);
  const byDay = {};
  state.weights.forEach(w=>{ byDay[w.day]=w; });

  cal.innerHTML = cells.map(c=>{
    const we = byDay[c.iso];
    const has = !!we;
    const lb = has ? round(we.lb,1) : "";
    return `
      <div class="calCell ${c.inMonth?"":"off"}" data-weight-iso="${c.iso}">
        ${has ? `<button class="calDel" type="button" data-del-weight="${c.iso}">✕</button>` : ""}
        <div class="calDay">${c.day}</div>
        ${has ? `<div class="calVal mono">${lb} lb</div>` : ""}
      </div>
    `;
  }).join("");

  // cell tap loads date into form
  cal.querySelectorAll("[data-weight-iso]").forEach(cell=>{
    cell.addEventListener("click", (e)=>{
      const iso = cell.getAttribute("data-weight-iso");
      const we = byDay[iso] || null;
      const dEl=document.getElementById("wDate");
      const lbEl=document.getElementById("wLb");
      if(dEl) dEl.value = iso;
      if(lbEl) lbEl.value = we ? (we.lb ?? "") : "";
      toast("Weight loaded", iso);
    });
  });

  // delete buttons
  cal.querySelectorAll("[data-del-weight]").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      e.preventDefault(); e.stopPropagation();
      deleteWeight(btn.getAttribute("data-del-weight"));
    });
  });
}
function renderSetup(){
  // profile
  document.getElementById("pAge").value = state.profile.age;
  document.getElementById("pHeight").value = state.profile.heightIn;
  document.getElementById("pWeight").value = state.profile.weightLb;
  document.getElementById("pGoalLoss").value = state.profile.goalLossLb;

  // plan
  document.getElementById("lossRate").value = String(state.plan.lossRateLbWk);
  document.getElementById("pace").value = String(state.plan.paceMph);
  const ws = String(Math.round(state.plan.walkShare*100/5)*5);
  document.getElementById("walkShare").value = ws;
  document.getElementById("walkShareLabel").textContent = `${ws}%`;

  // nutrition
  document.getElementById("autoTargets").checked = !!state.nutrition.autoTargets;
  document.getElementById("protPerLb").value = state.nutrition.protPerLbGoal;
  document.getElementById("fatPerLb").value = state.nutrition.fatPerLbGoal;
  document.getElementById("custP").value = state.nutrition.custom.p;
  document.getElementById("custC").value = state.nutrition.custom.c;
  document.getElementById("custF").value = state.nutrition.custom.f;

  // balance (carbs ⇄ fat)
  const bal = parseNum(state.nutrition.overrides.cfBalance ?? 0);
  const balEl = document.getElementById("cfBalance");
  if(balEl) balEl.value = String(clamp(bal, -150, 150));
  const labelEl = document.getElementById("cfBalanceLabel");
  if(labelEl) labelEl.textContent = `${bal>0?"+":""}${Math.round(bal)}g`;

  const tNow = macroTargets();
  const lineEl = document.getElementById("cfTargetsLine");
  if(lineEl) lineEl.textContent = `Carbs ${Math.round(tNow.cG)}g • Fat ${Math.round(tNow.fG)}g`;

// reminder
  document.getElementById("remEnabled").checked = !!state.nutrition.reminder.enabled;
  document.getElementById("remHour").value = state.nutrition.reminder.hour;
  document.getElementById("remMin").value = state.nutrition.reminder.minute;

  toggleAutoTargetsUI();
  renderMacroPreview();
  // update status line
  const el=document.getElementById("autoAdjustStatus");
  if(el) el.textContent = `Cal adjust: ${Math.round((state.nutrition.calAdjustFactor||1)*100)}%`;
}
function toggleAutoTargetsUI(){
  const on=document.getElementById("autoTargets").checked;
  document.getElementById("autoTargetsBox").style.display = on ? "" : "none";
  document.getElementById("customTargetsBox").style.display = on ? "none" : "";
  renderMacroPreview();
}
function renderMacroPreview(){
  const t=macroTargets();
  const el=document.getElementById("macroPreview");
  if(!el) return;
  el.textContent = `Targets: P ${Math.round(t.pG)}g • C ${Math.round(t.cG)}g • F ${Math.round(t.fG)}g • ${Math.round(t.kcal)} kcal`;
}
function renderCharts(){
  drawLine("weightChart", buildWeightSeries(90), { title:"Weight", emptyText:"Add 2+ weight entries." });
  drawLine("weightChart2", buildWeightSeries(90), { title:"Weight", emptyText:"Add 2+ weight entries." });
  drawWeekBars("walkWeekBars");

  const mode = state.ui?.complianceView || "weekly";
  const series = (mode === "daily") ? buildDailyComplianceSeries(21) : buildWeeklyComplianceSeries(8);
  const title = (mode === "daily") ? "Daily Compliance (last 21 days)" : "Weekly Compliance % (last 8 weeks)";
  compliancePts = drawLine("weeklyComplianceChart", series, { title, emptyText:"Log some days.", markers:true, okThreshold:90 });
}

function renderAll(){
  renderHeader();
  renderWalkTargets();
  renderMacroDash();
  renderMacroPage();
  renderCompliance();
  renderFoodsDropdowns();
  renderTodayFoodLog();
  renderWalkCalendar();
  renderWeightCalendar();
  renderCharts();
  maybeFireReminder();
  // show tune status
  renderMacroPreview();
  const statusEl=document.getElementById("autoAdjustStatus");
  if(statusEl){
    const loss=computeLast7WeightLoss();
    const comp7 = (()=>{ let ok=0; for(let i=0;i<7;i++){ const d=new Date(); d.setDate(d.getDate()-i); if(dayCompliant(todayISO(d))) ok++; } return (ok/7)*100; })();
    statusEl.textContent = (loss==null)
      ? `Auto-adjust: waiting for 2+ weigh-ins in last 7 days. (7-day compliance: ${Math.round(comp7)}%) • Cal adjust: ${Math.round((state.nutrition.calAdjustFactor||1)*100)}%`
      : `7-day loss: ${round(loss,2)} lb vs goal ${round(state.plan.lossRateLbWk,2)} lb/wk • 7-day compliance: ${Math.round(comp7)}% • Cal adjust: ${Math.round((state.nutrition.calAdjustFactor||1)*100)}%`;
  }
}

/* ===== actions ===== */
function deleteEntry(id){ state.foodEntries = state.foodEntries.filter(e=>e.id!==id); saveState(); }
function deleteWalk(day){ state.walkLogs = state.walkLogs.filter(w=>w.day!==day); saveState(); }
function deleteWeight(day){ state.weights = state.weights.filter(w=>w.day!==day); saveState(); }

/* ===== view switching ===== */
const viewMap = { dash:"view-dash", walk:"view-walk", macros:"view-macros", weight:"view-weight", setup:"view-setup" };
function setActiveTab(name){
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.tab===name));
  document.querySelectorAll("main section").forEach(s=>s.style.display="none");
  document.getElementById(viewMap[name] || viewMap.dash).style.display="";
  renderAll();
}

/* ===== wiring ===== */
function wireAll(){
  // tabs
  document.querySelectorAll(".tab").forEach(btn=>{
    bindTap(btn, ()=> setActiveTab(btn.dataset.tab));
  });

  // compliance view selector (dashboard)
  const compSel = document.getElementById("compViewSel");
  if(compSel){
    compSel.value = (state.ui?.complianceView || "weekly");
    compSel.addEventListener("change", ()=>{
      state.ui = state.ui || { complianceView:"weekly" };
      state.ui.complianceView = compSel.value;
      saveState();
    });
  }

  // compliance chart tooltip (tap/click nearest point)
  const compCanvas = document.getElementById("weeklyComplianceChart");
  if(compCanvas){
    const handler = (ev)=>{
      const rect = compCanvas.getBoundingClientRect();
      const x = (ev.touches && ev.touches[0]) ? ev.touches[0].clientX : ev.clientX;
      const cx = (x - rect.left) * (window.devicePixelRatio || 1);

      if(!compliancePts || compliancePts.length===0) return;
      let best = compliancePts[0], bestDx = Math.abs(compliancePts[0].x - cx);
      for(const p of compliancePts){
        const dx = Math.abs(p.x - cx);
        if(dx < bestDx){ bestDx = dx; best = p; }
      }
      const d = best.data || {};
      const mode = state.ui?.complianceView || "weekly";

      if(mode === "daily"){
        const iso = d.label;
        const wOK = walkCompliant(iso);
        const mOK = macroCompliant(iso);
        if(d.ok===null){
        toast("No compliance data", `${iso} • Log walk and/or food entries to track.`);
      }else{
        const ok = d.ok;
        toast(ok ? "Compliant *" : "Not compliant !", `${iso} • Walk ${wOK?"OK":"NO"} • Macros ${mOK?"OK":"NO"}`);
      }
      }else{
        const wk = d.label;
        if(!Number.isFinite(d.y)){
        toast("No compliance data", `${wk} week • Log some days to track.`);
      }else{
        const okDays = (typeof d.okDays === "number") ? d.okDays : Math.round((d.y/100)*7);
        const pct = Math.round(d.y);
        const ok = pct >= 90;
        toast(ok ? "Compliant *" : "Not compliant !", `${wk} week • ${okDays}/7 days • ${pct}%`);
      }
      }
    };
    compCanvas.addEventListener("click", handler);
    compCanvas.addEventListener("touchstart", (e)=>{ handler(e); }, { passive:true });
  }

  // dashboard
  bindTap("btnGoSetup", ()=> setActiveTab("setup"));
  bindTap("btnGoMacros", ()=> setActiveTab("macros"));
  bindTap("btnGoWeight", ()=> setActiveTab("weight"));
  bindTap("btnQuickAddFood", ()=> { setActiveTab("macros"); openEntryCard(); });

  bindTap("btnQuickLogWalk", ()=>{
    setActiveTab("walk");
    document.getElementById("walkDate").value = todayISO();
    const existing = walkLogForDay(todayISO());
    document.getElementById("walkMiles").value = existing ? existing.miles : "";
    document.getElementById("walkMinutes").value = existing ? existing.minutes : "";
  });

  bindTap("btnLogWeight", ()=>{
    setActiveTab("weight");
    document.getElementById("wDate").value = todayISO();
    document.getElementById("wLb").value = "";
  });

  // compliance dropdown (dashboard)
  const compYN = document.getElementById("complianceSel");
  const reasonWrap = document.getElementById("reasonWrap");
  if(compYN){
    compYN.addEventListener("change", ()=>{
      const v = compYN.value;
      if(reasonWrap) reasonWrap.style.display = (v === "no") ? "" : "none";
      if(v === "yes"){
        // choosing Yes clears any saved reason for today
        const iso = todayISO();
        if(state.reasons && state.reasons[iso]){
          delete state.reasons[iso];
          saveState();
        }else{
          renderCompliance();
        }
      }
    });
  }

  // reasons
  bindTap("saveReason", ()=>{
    const iso=todayISO();
    const txt=(document.getElementById("reasonText").value||"").trim();
    if(!state.reasons) state.reasons={};
    if(txt) state.reasons[iso]=txt;
    else delete state.reasons[iso];
    saveState();
    toast("Saved reason", txt ? "Stored for today." : "Cleared.");
  });
  bindTap("clearReason", ()=>{
    document.getElementById("reasonText").value="";
  });

  // walk
  bindTap("backFromWalk", ()=> setActiveTab("dash"));
  bindTap("saveWalk", ()=>{
    const day=document.getElementById("walkDate").value || todayISO();
    let miles=parseNum(document.getElementById("walkMiles").value);
    let minutes=parseNum(document.getElementById("walkMinutes").value);

    if(miles<=0 && minutes>0) miles=(minutes/60)*state.plan.paceMph;
    if(minutes<=0 && miles>0) minutes=(miles/state.plan.paceMph)*60;
    if(miles<=0 && minutes<=0) return toast("Missing walk info", "Enter miles and/or minutes.");

    const idx=state.walkLogs.findIndex(w=>w.day===day);
    const rec={ day, miles, minutes:Math.round(minutes) };
    if(idx>=0) state.walkLogs[idx]=rec; else state.walkLogs.push(rec);
    state.walkLogs.sort((a,b)=>b.day.localeCompare(a.day));
    saveState();
    toast("Saved walk", `${round(miles,1)} mi • ${Math.round(minutes)} min`);
  });

  // macros: open/close
  bindTap("btnOpenEntry", ()=> openEntryCard());
  bindTap("closeEntry", ()=> closeEntryCard());
  bindTap("btnOpenFood", ()=> openFoodCard());
  bindTap("hideAddFood", ()=> closeFoodCard());

  function openEntryCard(){ document.getElementById("entryCard").style.display=""; }
  function closeEntryCard(){ document.getElementById("entryCard").style.display="none"; }
  function openFoodCard(){ document.getElementById("addFoodCard").style.display=""; }
  function closeFoodCard(){ document.getElementById("addFoodCard").style.display="none"; }

  // expose for dash button
  window.openEntryCard = openEntryCard;

  bindTap("clearEntry", ()=>{ document.getElementById("entryOz").value=""; });

  // save entry
  bindTap("saveEntry", ()=>{
    const meal=document.getElementById("mealSel").value;
    const group=document.getElementById("pickedGroup").value;
    const oz=parseNum(document.getElementById("entryOz").value);
    if(oz<=0) return toast("Missing ounces", "Enter ounces (e.g., 6).");

    let foodId="";
    if(group==="protein") foodId=document.getElementById("foodSelProtein").value;
    if(group==="grains") foodId=document.getElementById("foodSelGrains").value;
    if(group==="fruitsveg") foodId=document.getElementById("foodSelFv").value;

    if(!foodId) return toast("Pick a food", "Select a food in the chosen dropdown.");

    state.foodEntries.push({ id:uid(), day:todayISO(), meal, foodId, oz, ts:Date.now() });
    state.foodEntries.sort((a,b)=>(b.day.localeCompare(a.day)) || ((b.ts||0)-(a.ts||0)));
    document.getElementById("entryOz").value="";
    saveState();
    toast("Saved entry", `${round(oz,1)} oz • ${capitalize(meal)}`);
  });

  // save food
  bindTap("saveFood", ()=>{
    const cat=document.getElementById("foodCat").value;
    const name=(document.getElementById("foodName").value||"").trim();
    const p=parseNum(document.getElementById("foodP").value);
    const c=parseNum(document.getElementById("foodC").value);
    const f=parseNum(document.getElementById("foodF").value);
    if(!name) return toast("Missing food name", "Enter a name.");

    state.foods.unshift({ id:uid(), cat, name, p, c, f });
    document.getElementById("foodName").value="";
    document.getElementById("foodP").value="";
    document.getElementById("foodC").value="";
    document.getElementById("foodF").value="";
    closeFoodCard();
    saveState();
    toast("Saved food", name);
  });

  // weight
  bindTap("backFromWeight", ()=> setActiveTab("dash"));
  bindTap("saveWeight", ()=>{
    const day=document.getElementById("wDate").value || todayISO();
    const lb=parseNum(document.getElementById("wLb").value);
    if(lb<=0) return toast("Missing weight", "Enter weight in lb.");

    const idx=state.weights.findIndex(w=>w.day===day);
    const rec={ day, lb };
    if(idx>=0) state.weights[idx]=rec; else state.weights.push(rec);
    state.weights.sort((a,b)=>b.day.localeCompare(a.day));
    document.getElementById("wLb").value="";
    saveState();
    toast("Saved weight", `${round(lb,1)} lb`);

    // after weigh-in, attempt auto-adjust if needed
    autoAdjustIfNeeded();
  });

  // setup controls
  document.getElementById("walkShare").addEventListener("input", ()=>{
    document.getElementById("walkShareLabel").textContent = `${document.getElementById("walkShare").value}%`;
  });
  document.getElementById("autoTargets").addEventListener("change", toggleAutoTargetsUI);
  ["protPerLb","fatPerLb","custP","custC","custF","cfBalance"].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.addEventListener("input", renderMacroPreview);
  });

  // carbs ⇄ fat balance (daily)
  const BAL_CARBS_CENTER = 200;
  const BAL_FAT_CENTER   = 69;

  const updateBalance = (delta)=>{
    delta = clamp(parseNum(delta), -150, 150); // 1g steps, wider range
    state.nutrition.overrides.cfBalance = delta;

    // Keep PROTEIN + TOTAL CALORIES constant; trade carbs ⇄ fat around the center point.
    // Calories baseline = (protein * 4) + (200g carbs * 4) + (69g fat * 9)
    const baseP = baseMacroTargets().pG;
    const kcalFixed = (baseP*4) + (BAL_CARBS_CENTER*4) + (BAL_FAT_CENTER*9);

    const C = Math.max(0, BAL_CARBS_CENTER + delta);
    const F = Math.max(0, (kcalFixed - (baseP*4) - (C*4)) / 9);

    const lab=document.getElementById("cfBalanceLabel");
    if(lab) lab.textContent = `${delta>0?"+":""}${Math.round(delta)}g`;

    const line=document.getElementById("cfTargetsLine");
    if(line) line.textContent = `Carbs ${Math.round(C)}g • Fat ${Math.round(F)}g`;

    // Re-render macro preview/targets elsewhere
    renderMacroPreview();
  };

  const balEl=document.getElementById("cfBalance");
  if(balEl){
    balEl.addEventListener("input", ()=>{
      updateBalance(balEl.value);
      saveState();
    });
  }

  bindTap("resetBalance", ()=>{
    if(balEl) balEl.value="0";
    updateBalance(0);
    saveState();
    toast("Balance reset", "Carbs back to 200g (fat auto-adjusted).");
  });

bindTap("testReminder", ()=> toast("WalkCut reminder", "Test reminder ✅"));

  bindTap("saveSetup", ()=>{
    state.profile.age = clamp(parseInt(document.getElementById("pAge").value||"44",10)||44, 18, 90);
    state.profile.heightIn = clamp(parseInt(document.getElementById("pHeight").value||"73",10)||73, 48, 90);
    state.profile.weightLb = clamp(parseNum(document.getElementById("pWeight").value||"225"), 90, 600);
    state.profile.goalLossLb = clamp(parseNum(document.getElementById("pGoalLoss").value||"30"), 1, 200);

    state.plan.lossRateLbWk = clamp(parseNum(document.getElementById("lossRate").value||"1.0"), 0.25, 2.5);
    state.plan.paceMph = clamp(parseNum(document.getElementById("pace").value||"3.5"), 2.0, 6.0);
    state.plan.walkShare = clamp(parseNum(document.getElementById("walkShare").value||"70")/100, 0, 1);

    state.nutrition.autoTargets = !!document.getElementById("autoTargets").checked;
    state.nutrition.protPerLbGoal = clamp(parseNum(document.getElementById("protPerLb").value||"1.01"), 0.4, 1.6);
    state.nutrition.fatPerLbGoal = clamp(parseNum(document.getElementById("fatPerLb").value||"0.30"), 0.15, 0.7);

    state.nutrition.custom = {
      p: clamp(parseNum(document.getElementById("custP").value||"180"), 50, 350),
      c: clamp(parseNum(document.getElementById("custC").value||"200"), 0, 500),
      f: clamp(parseNum(document.getElementById("custF").value||"60"), 10, 200)
    };

    state.nutrition.reminder.enabled = !!document.getElementById("remEnabled").checked;
    state.nutrition.reminder.hour = clamp(parseInt(document.getElementById("remHour").value||"19",10)||19, 0, 23);
    state.nutrition.reminder.minute = clamp(parseInt(document.getElementById("remMin").value||"0",10)||0, 0, 59);

    saveState();
    toast("Saved setup", "Your plan + reminder time were saved.");
    setActiveTab("dash");
  });

  bindTap("backFromSetup", ()=> setActiveTab("dash"));

  bindTap("resetAll", ()=>{
    if(confirm("Reset ALL WalkCut data on this device?")){
      localStorage.removeItem(LS_KEY);
      state = loadState();
      renderSetup();
      renderAll();
      toast("Reset complete", "All WalkCut data was cleared.");
      setActiveTab("dash");
    }
  });

  // month selectors (calendar views)
  const wms = document.getElementById("weightMonthSel");
  if(wms){
    wms.addEventListener("change", ()=>{
      state.ui = state.ui || {};
      state.ui.weightMonth = wms.value;
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      renderWeightCalendar();
    });
  }
  const kms = document.getElementById("walkMonthSel");
  if(kms){
    kms.addEventListener("change", ()=>{
      state.ui = state.ui || {};
      state.ui.walkMonth = kms.value;
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      renderWalkCalendar();
    });
  }

}

/* ===== init ===== */
(function init(){
  // date inputs
  document.getElementById("walkDate").value = todayISO();
  document.getElementById("wDate").value = todayISO();

  renderSetup();
  wireAll();
  setActiveTab("dash");
  renderAll();

  // reminder polling while open
  setInterval(maybeFireReminder, 60*1000);

  // redraw on resize
  window.addEventListener("resize", ()=> renderCharts());
})();
</script>
</body>
</html>
